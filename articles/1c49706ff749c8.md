---
title: "Vim9 scriptã§æ›¸ã„ãŸ.vimrcã®ãƒ†ã‚¹ãƒˆã‚’Vim9 scriptã§æ›¸ã„ã¦Github Actionsã§pushæ™‚ã«å®Ÿè¡Œã•ã›ãŸè©±"
emoji: "âœ…"
type: "tech"
topics:
  - "vim"
published: true
published_at: "2023-03-31 14:42"
---

## åˆã‚ã«
Vim9 scriptã§æ›¸ã„ãŸ.vimrcã®ãƒ†ã‚¹ãƒˆã‚’Vim9 scriptã§æ›¸ã„ã¦Github Actionsã§Pushæ™‚ã«ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸ

ã‚‚ã¨ã‚‚ã¨vimæ¨™æº–ã®assertã‚’ä½¿ã£ã¦ã€ŒVim9 scriptã§æ›¸ã„ãŸ.vimrcã®ãƒ†ã‚¹ãƒˆã‚’Vim9 scriptã§æ›¸ã„ã¦ã€ã¯ã‚„ã£ã¦ã„ãŸã®ã§ã™ãŒ
æŸèª­æ›¸ä¼šã§ã€Œè‡ªå‹•ã§ãƒ†ã‚¹ãƒˆã—ãªã„ã®ï¼Ÿã€ã€Œvim-themisè‰¯ã„ã‚ˆãƒ¼ã€ã¨æ•™ãˆã¦ã„ãŸã ã„ãŸã®ã§ã‚„ã£ã¦ã¿ã¾ã—ãŸ
ã“ã®å ´ã‚’ã‹ã‚Šã¦èª­æ›¸ä¼šã®çš†æ§˜ã«æ„Ÿè¬ã‚’ğŸ™

## ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
ã¨ã„ã†ã‚ã‘ã§ãƒ†ã‚¹ãƒˆã‚’[vim-themis](https://github.com/thinca/vim-themis)ã§æ›¸ãç›´ã—ã¾ã™
`themis#helper('expect')`ã¯é–¢æ•°ã¸ã®å‚ç…§ãªã®ã§å…ˆé ­å¤§æ–‡å­—ã®å¤‰æ•°ã«ä»£å…¥ã—ãªã„ã¨ã„ã‘ãªã„ã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™

ã ã„ãŸã„ã“ã‚“ãªæ„Ÿã˜ã§ã™
(å…¨éƒ¨æ›¸ãã¨é•·ã„ã®ã§å…¨ã¦ã‚’èª­ã¿ãŸã„å¥‡ç‰¹ãªæ–¹ã¯è¨˜äº‹æœ€å¾Œè¨˜è¼‰ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’å‚ç…§ãã ã•ã„)
```vim
vim9script

var suite = themis#suite('Test for .vimrc')
const assert = themis#helper('assert')
const Expect = themis#helper('expect')

source expand('~/.vimrc')

suite.Foo = () => {
    assert.equals('foo', 'foo')
    Expect('bar').to_be('bar')
}
```

çµæœã¯çœç•¥
themisã®å‡ºåŠ›ã€è¦‹ã‚„ã™ãã¦ã‚ˆã„ã§ã™ã­

### .vimrcå†…ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ­ãƒ¼ã‚«ãƒ«ãªé–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã„
SIDã‚’`scriptnames`ã§å–å¾—ã§ãã‚‹ã®ã§ãã‚Œã‚’åˆ©ç”¨ã—ã¾ã™
(vital.vimã«ã‚‚ã‚ã£ãŸã‚ˆã†ãªï¼Ÿ)
```vim
# ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ­ãƒ¼ã‚«ãƒ«ãªé–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«SIDã‚’ç¢ºä¿ã—ã¦ãŠã
var scriptnames_output = ''
redir => scriptnames_output
silent scriptnames
redir END
const vimrc_sid = scriptnames_output
  ->split("\n")
  ->filter((i, v) => v =~# '/\.vimrc$')[0]
  ->matchstr('\d\+')

suite.Bar = () => {
    const F = function($'<SNR>{vimrc_sid}_BUZ')
    assert.equals(F('buz'), 'hello sid!')
}
```

## Github Actionã«ç™»éŒ²ã™ã‚‹
[ã“ã¡ã‚‰](https://qiita.com/stackline/items/6a7fa64d2291171cb3c2)ã‚’å‚è€ƒã«ä½œæˆã—ã¾ã™

ãŸã ã—ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹vimã¯å¤ã„ã®ã§Vim9 scriptãŒå‹•ãã¾ã›ã‚“
`sudo add-apt-repository ppa:jonathonf/vim`ã§å–å¾—å…ˆã‚’å¤‰æ›´ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸ([å‚è€ƒ](https://dev.to/kaede_io/vim-ubunt-no-vim-wo-81-kara-90-nishang-geru-38o5))


å‡ºæ¥ä¸ŠãŒã£ãŸSimple Workflowã®è¨­å®šãŒã“ã¡ã‚‰
```yaml
# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "master" branch
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨6æ™‚é–“ãªã®ã§é•·ã™ãã‚‹â€¦)
    timeout-minutes: 15

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # .vimrcã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3

      # vimã¨gitã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
      - name: Initialize
        run: |
          sudo apt-get update
          sudo add-apt-repository ppa:jonathonf/vim
          sudo apt-get install -y vim git
          ln -s $GITHUB_WORKSPACE/.vimrc ~/.vimrc
          # vim-jetpackã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå…¥ã£ãŸçŠ¶æ…‹ã§ãƒ†ã‚¹ãƒˆã—ãŸã„ã®ã§
          # JetpackSyncã‚’å®Ÿè¡Œã—ã¦ãŠã â†’ ã“ã“ã«ç½ ãŒï¼(å¾Œè¿°)
          vim -c JetpackSync -c qa!

      # ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
      - name: Run tests
        run: |
          cd $GITHUB_WORKSPACE/test
          # themisã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã¯ç’°å¢ƒã«åˆã‚ã›ã¦ãã ã•ã„
          ~/.vim/pack/jetpack/opt/vim-themis/bin/themis vimrc.test.vim
```

## ã“ã‚Œã§ã„ã„ã¨æ€ã£ã¦ã¾ã—ãŸãŒâ€¦

è»½ãæ›¸ã„ãŸãƒ†ã‚¹ãƒˆãŒé€šã£ãŸã®ã§ã€ãƒ¨ã‚·ï¼ã¨æ€ã£ã¦ãŸã®ã§ã™ãŒ
ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ (themisã®vimèµ·å‹•ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«`-u NONE`ã£ã¦ã‚ã‚Šã¾ã™ã—)
ã¾ãŸã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å†…ã§`source .vimrc`ã‚’ã—ã¦ã„ã‚‹ã®ã§.vimrcã«ã‹ã‹ã‚ŒãŸVimEnterã‚¤ãƒ™ãƒ³ãƒˆãŒå‹•ãã¾ã›ã‚“
.vimrcå†…ã®VimEnterã‚’ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„ã‚ˆã†ã«é–¢æ•°ã«ä¿®æ­£ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æ–¹ã¯æ‰‹ã‚’ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“
ãã‚‚ãã‚‚ä»Šå›ã®ç›®çš„ã¯themisã¨ã¯ã¡ã‚‡ã£ã¨åˆã‚ãªã‹ã£ãŸã‚ˆã†ã§ã™(èªè­˜é–“é•ã£ã¦ã„ãŸã‚‰ã™ã¿ã¾ã›ã‚“ğŸ’¦)

ãªã®ã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã«ç°¡å˜ãªãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æ›¸ãã¾ã—ãŸ
ã“ã“ã¾ã§ããŸã‚‰vimæ¨™æº–ã®assertã‚’ä½¿ã£ã¦ã‚‚ã„ã„ã‹ã¨æ€ã„ã¾ã—ãŸãŒã›ã£ã‹ããªã®ã§themisã¨åŒã˜å½¢ã§å®Ÿè£…ã—ã¾ã—ãŸ
ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ãŸã‚‰`cq`ã§æŠœã‘ã‚‹å½¢ã«ã™ã‚Œã°Github Actionsã«ã‚¨ãƒ©ãƒ¼ã‚’ä¼ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã§ã™
ã¤ã„ã§ã«ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’é–‹ã„ã¦`:so %`ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã—ãŸ

```vim
# Github Actionsã§ä»¥ä¸‹ã®é€šã‚Šå®Ÿè¡Œã™ã‚‹
# cd $GITHUB_WORKSPACE/test
# vim -c vimrc.test.vim

# `:source %`ã§å®Ÿè¡Œã—ãŸå ´åˆã¯çµ‚äº†ã•ã›ãªã„
var is_manually_run = expand('%:t') ==# 'vimrc.test.vim'
var suite = {}
var assert = {}
var is_faild = false

def! g:RunTests()
  is_faild = false
  for s in suite->keys()
    echom s
    suite[s]()
  endfor
  echom is_faild ? 'Tests faild.' : 'Tests success.'
  if !is_manually_run
    execute is_faild ? 'cq!' : 'q!'
  endif
enddef

assert.equals = (act: any, exp: any, msg: string = 'assert.equals') => {
  if act !=# exp
    is_faild = true
    echom $'  {msg}'
    echom $'    act: {act}'
    echom $'    exp: {exp}'
  endif
}

assert.falsy = (act: any, msg: string = 'assert.falsy') => {
  assert.equals(act, false, msg)
}

suite.Foo = () => {
    assert.equals('foo', 'foo')
    Expect('bar').to_be('bar')
}

call g:RunTests()
```

Simple Workflowã®è¨­å®šã‚‚æœ€å¾Œã ã‘ç›´ã—ã¦ãŠãã¾ã™
```yaml
      - name: Run tests
        run: |
          cd $GITHUB_WORKSPACE/test
          vim -S vimrc.test.vim
```

ãƒ†ã‚¹ãƒˆãŒé€šã£ãŸã®ã§ãƒ¨ã‚·ï¼

## çµ‚ã‚ã‚Šã«
å¾ŒåŠã¯ã¨ã‚‚ã‹ãã€å‰åŠã¯Vim9 script + vim-themis + Github Actionsã®å‚è€ƒã«ãªã‚Œã°å¬‰ã—ã„ã§ã™
å…¨ã‚½ãƒ¼ã‚¹ã¯ã“ã¡ã‚‰ã«ã‚ã‚Šã¾ã™
https://github.com/utubo/dotfiles

